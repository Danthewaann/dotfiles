#!/usr/bin/env bash

set -eo pipefail

CUR_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

source "$CUR_DIR/_git-common"

args=()
branch_name=
checkout_only=0
copy_venv=0

function usage() {
    cat <<-END > /dev/stderr

Usage:
    branch_name      name of the branch to create

    --checkout-only  only checkout the branch
    --copy           copy .venv from base worktree into new worktree
END
}

while [[ $# -gt 0 ]]; do
    case $1 in
    -h|--help)
        usage
        exit 2
        ;;
    --checkout-only)
        checkout_only=1
        shift
        ;;
    --copy)
        copy_venv=1
        shift
        ;;
    *)
        args+=("$1")
        shift
        ;;
    esac
done

>&2 echo

set -- "${args[@]}"

if [[ $# -lt 1 ]]; then
    error "Must provide a branch name!"
    usage
    exit 1
fi

branch_name="$1"; shift

# If the branch name starts with `origin/` remove that section
if [[ "$branch_name" == origin/* ]]; then
    branch_name=$(echo "$branch_name" | cut -d'/' -f2-)
fi

# Convert all forward slashes to dashes
converted_name=${branch_name//\//-}
# Convert dots to underscores as tmux sessions can't contain dots
converted_name=$(tr . _ <<< "$converted_name")

# If we are already inside a worktree change directory to the bare repo
if ! is_bare_repo=$(git rev-parse --is-inside-work-tree 2>&1); then true; fi
if [[ $is_bare_repo == "true" ]]; then
    cd "$(gitw-get 2> /dev/null)/.."
fi

# Make sure we are inside a bare repo before proceeding
if ! is_bare_repo=$(git rev-parse --is-bare-repository 2>&1); then true; fi
if [[ $is_bare_repo != "true" ]]; then
    error "Must be run in a worktree or bare repository!"
    exit 1
fi

# If the worktree already exists, switch to it
if [[ -d $converted_name ]]; then
    info "Switching to worktree..."
    cd "$converted_name" || exit
    sleep 0.3
    tmux-sessionizer "$(pwd)" "$@"
    exit $?
fi

info "Running git fetch..."
if ! output=$(git -c color.ui=always fetch 2>&1); then
    >&2 echo "$output"
    exit 1
else
    if [[ -n "$output" ]]; then
        >&2 echo "$output"
    fi
fi
>&2 echo

base_branch=$(git-get-base-branch)

if [[ "$branch_name" != "$base_branch" ]]; then
    # Check if branch already exists locally
    local_branch_arg=
    if ! git branch | grep "\w*$branch_name\$" > /dev/null; then
        local_branch_arg="-b" 
    fi

    # Check if branch already exists remotely
    remote_branch_arg=
    if git branch -r | grep "\w*origin/$branch_name\$" > /dev/null; then
        remote_branch_arg="--track origin/$branch_name"
    fi
fi

# Create a new worktree using the converted name whilst checking out the branch
info "Creating worktree..."
# shellcheck disable=SC2086
if ! output=$(git worktree add "$converted_name" $local_branch_arg "$branch_name" $remote_branch_arg 2>&1); then
    error "$output"
    exit 1
else
    if [[ -n "$output" ]]; then
        >&2 echo "$output"
    fi
fi

# Enter the new worktree
cd "$converted_name" || exit

# Optional post checkout steps
if [[ $checkout_only -ne 1 ]]; then
    current_dir=$(pwd)
    base_worktree=$(gitw-get 2> /dev/null)

    if [[ $copy_venv -eq 1 ]] && [[ -d "$base_worktree/.venv" ]]; then
        >&2 echo
        info "Copying ../$base_worktree/.venv to $converted_name/.venv"
        mkdir -p "$current_dir/$converted_name/.venv"
        # From https://www.zylk.net/en/web-2-0/blog/-/blogs/how-to-copy-files-in-linux-faster-and-safer-than-cp
        cd "$base_worktree/.venv"; tar cf - . | (cd "$current_dir/$converted_name/.venv"; tar xvf -) 2> /dev/null
    elif [[ -f "poetry.lock" ]]; then
        >&2 echo
        info "Running poetry install..."
        >&2 echo
        if ! poetry install --all-extras > /dev/stderr 2>&1; then true; fi
    fi
fi

>&2 echo
success "Successfully created worktree!"

>&2 echo
info "Switching to worktree..."
sleep 0.3
tmux-sessionizer "$(pwd)" "$@"
tmux-reset-cache &
