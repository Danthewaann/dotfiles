#!/usr/bin/env python3

import os
import pathlib
import re
import subprocess
import sys
import _utils

# From: https://morgan.cugerone.com/blog/workarounds-to-git-worktree-using-bare-repository-and-cannot-fetch-remote-branches/
#
# Examples of call:
# git-clone-bare git@github.com:name/repo.git
# => Clones to a /repo directory
#
# git-clone-bare git@github.com:name/repo.git my-repo
# => Clones to a /my-repo directory

if len(sys.argv) < 2:
    _utils.info("Usage: git-clone-bare <git url or user/name> [name]")
    sys.exit(1)

url = sys.argv[1]
if url.startswith("git@github.com"):
    name = (
        pathlib.Path(sys.argv[2])
        if len(sys.argv) > 2
        else pathlib.Path(pathlib.Path(url).stem)
    )
elif re.match(r"^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$", url):
    name = pathlib.Path(url)
    url = f"git@github.com:{url}.git"
else:
    _utils.error(
        "Invalid value provided, must be a 'git@github.com' url or a '<user>/<repo>' string"
    )
    sys.exit(1)

name.mkdir(parents=True, exist_ok=True)
os.chdir(name)

# Moves all the administrative git files (a.k.a $GIT_DIR) under .bare directory.
#
# Plan is to create worktrees as siblings of this directory.
# Example targeted structure:
# .bare
# main
# new-awesome-feature
# hotfix-bug-12
# ...
print(file=sys.stderr)
_utils.info("Cloning bare repository...")
_utils.run_command(["git", "clone", "--bare", url, ".bare"])

with open(".git", "w") as git_file:
    git_file.write("gitdir: ./.bare\n")

# Explicitly sets the remote origin fetch so we can fetch remote branches
subprocess.run(
    ["git", "config", "remote.origin.fetch", "+refs/heads/*:refs/remotes/origin/*"]
)

# Gets all branches from origin
print(file=sys.stderr)
_utils.info("Fetching remote branches...")
_utils.run_command(["git", "fetch", "origin"])

# Creating base worktree
print(file=sys.stderr)
_utils.info("Creating base worktree...")
print(file=sys.stderr)
base_branch = _utils.get_base_branch()
subprocess.run(["gitw-add", base_branch])
