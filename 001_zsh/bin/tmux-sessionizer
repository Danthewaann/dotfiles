#!/usr/bin/env bash

if [[ $# -eq 1 ]]; then
    selected=$1
else
    default_locations=("$HOME/Workspace")

    while IFS=$'\n' read -r line; do
        # If this directory is a bare git repository, get a list of all immediate sub-directories.
        if ls "$line"/.bare > /dev/null 2>&1; then
            while IFS=$'\n' read -r line2; do default_locations+=("$line2"); done < <(find "$line" -mindepth 1 -maxdepth 1 -type d -not -name '.*')
        fi

        default_locations+=("$line")
    done < <(find "$HOME"/Workspace -mindepth 1 -maxdepth 1 -type d)
    # shellcheck disable=SC2086
    selected=$(printf "%s\n" "${default_locations[@]}" | "$HOME"/.tmux/plugins/tmux-fzf/scripts/.fzf-tmux $TMUX_FZF_OPTIONS)
fi

if [[ -z $selected ]]; then
    exit 0
fi

# If this parent directory for the selected directory is a bare git repository,
# prepend the parent directory to the selected directory.
if ls "$selected/../.bare" > /dev/null 2>&1; then
    selected_name=$(basename "$(dirname "$selected")")/$(basename "$selected" | tr . _)
else
    selected_name=$(basename "$selected" | tr . _)
fi

tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s "$selected_name" -c "$selected"
    exit 0
fi

if ! tmux has-session -t="$selected_name" 2> /dev/null; then
    tmux new-session -ds "$selected_name" -c "$selected"
fi

tmux switch-client -t "$selected_name"
