#!/bin/bash

set -e

args=()
pr_types=(python ruby go docker docs)
pr_type=
pr_title=

while [[ $# -gt 0 ]]; do
    case $1 in
    -l|--label)
        if [[ " ${pr_types[*]} " =~ " ${2} " ]]; then
            pr_type=$2
        fi
        args+=($1 $2)
        shift; shift
        ;;
    -t|--title)
        pr_title="$2"
        shift; shift
        ;;
    esac
done

if [[ -z $pr_type ]]; then
    >&2 echo "\nERROR: you need to provide a PR type as a label in (${pr_types[@]})"
    return 1
fi

if [[ -z $pr_title ]]; then
    pr_title=$(git log -1 --pretty=%B)
    >&2 echo "\nNo PR title provided, defaulting to last commit message \"$pr_title\""
else
    >&2 echo "\nUsing \"$pr_title\" as PR title"
fi

gh pr create \
    --head "$(git branch --show-current)" \
    --assignee "@me" \
    --title "$pr_title" \
    "$args" || return $?

local url=$(gh pr view --json url --jq .url)

>&2 echo "\nThe below has been copied to your clipboard! ðŸ“‹\n"
output=$(printf "%s\n:point_up: :%s: %s\n" "$url" "$pr_type" "$pr_title")
echo "$output"
echo "$output" | pbcopy

