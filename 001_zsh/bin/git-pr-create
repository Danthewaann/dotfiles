#!/usr/bin/env bash

set -uoe pipefail

CUR_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

source "$CUR_DIR/_git-common"

args=()

# Github label to slack emoji associate array
declare -A pr_types=(
    [python]="python"
    [ruby]="ruby_prog"
    [go]="go"
    [docker]="docker"
    [documentation]="docs"
)

pr_type=
pr_title=
pr_is_draft=0
labels=()

function usage() {
    gh pr create --help
}

function pr_info() {
    url=$(gh pr view --json url --jq .url)
    slack_label=""

    if [[ -n $pr_type ]]; then
        slack_label=" :${pr_types[$pr_type]}:"
    fi

    if [[ $pr_is_draft -ne 0 ]]; then
        output=$(printf "%s\n:point_up:%s [Draft PR] %s\n" "$url" "$slack_label" "$pr_title")
    else
        output=$(printf "%s\n:point_up:%s %s\n" "$url" "$slack_label" "$pr_title")
    fi

    >&2 printf "\nThe below has been copied to your clipboard! ðŸ“‹\n\n"
    echo "$output"
    echo "$output" | pbcopy
}

while [[ $# -gt 0 ]]; do
    case $1 in
    -h|--help)
        usage
        exit 2
        ;;
    -l|--label)
        # shellcheck disable=SC2076
        if [[ " ${!pr_types[*]} " =~ " ${2} " ]]; then
            pr_type=$2
        fi
        args+=("$1" "$2")
        labels+=("$2")
        shift; shift
        ;;
    -t|--title)
        pr_title="$2"
        shift; shift
        ;;
    -d|--draft)
        pr_is_draft=1
        args+=("$1")
        shift 
        ;;
    *)
        args+=("$1")
        shift
        ;;
    esac
done

# Check if a PR has already been opened for the current branch
if pr_title=$(gh pr list | grep "$(git branch --show-current)" | cut -f2); then
    >&2 echo
    warn "A PR has already been opened for this branch"
    pr_info
    exit 1
fi

# Get list of labels that are available in the current repository
repo_labels=()
while IFS=$'\n' read -r label; do repo_labels+=("$label"); done < <(gh label list --json name --jq '.[].name' --limit 100)

# Make sure that all of the provided labels are in `repo_labels`
invalid_labels=()
for label in "${labels[@]}"; do
    # shellcheck disable=SC2076
    if [[ ! " ${repo_labels[*]} " =~ " ${label} " ]]; then
        invalid_labels+=("$label")
    fi
done

# If we have an invalid labels we print an error and exit
if [[ ${#invalid_labels[@]} -ne 0 ]]; then
    >&2 echo
    error "The following labels were not found in git repository"
    >&2 echo
    >&2 printf "invalid labels -> (%s)\n" "${invalid_labels[*]}"
    >&2 echo

    >&2 echo "Here are the top 100 valid labels for this git repository:"
    >&2 echo
    gh label list --json name --jq '.[].name' --limit 100
    exit 1
fi

if [[ -z $pr_title ]]; then
    pr_title=$(git log -1 --pretty=%B)
    >&2 printf "\nNo PR title provided, defaulting to last commit message \"%s\"\n" "$pr_title"
else
    >&2 printf "\nUsing \"%s\" as PR title\n" "$pr_title"
fi

export GIT_PR_CREATE_RAN=1

cur_time=$(date +%s)
pr_file_name=git-pr-create."$cur_time".md

if [[ -f .github/PULL_REQUEST_TEMPLATE.md ]]; then
    cp .github/PULL_REQUEST_TEMPLATE.md "$pr_file_name"
else
    touch "$pr_file_name"
fi

$EDITOR "$pr_file_name"

if [[ -f .github/PULL_REQUEST_TEMPLATE.md ]]; then
    pr_template_md5=$(md5 -q .github/PULL_REQUEST_TEMPLATE.md)
    file_md5=$(md5 -q "$pr_file_name")

    if [[ "$file_md5" == "$pr_template_md5" ]]; then
        rm -f "$pr_file_name"
        exit 1
    fi
elif [[ ! -s "$pr_file_name" ]]; then
    rm -f "$pr_file_name"
    exit 1
fi

gh pr create \
    --head "$(git branch --show-current)" \
    --assignee "@me" \
    --title "$pr_title" \
    --body-file "$pr_file_name" \
    "${args[@]}" || exit $?

if [[ -n "$pr_type" ]]; then
    pr_info
fi

rm -f "$pr_file_name"
