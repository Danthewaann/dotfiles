#!/bin/bash

set -e

# Delete all git worktrees in current bare repository
barerepo=$(git rev-parse --is-bare-repository)
if [[ $barerepo != "true" ]]; then
    echo "Must be run in bare repository"
    return 1
fi

worktrees=($(git w list | grep -vE "(\[main\]|\[master\]|\(bare\))" | cut -d' ' -f1))
if [[ ${#worktrees[@]} -eq 0 ]]; then
    echo "No worktrees to delete"
    return 1
fi

for worktree in $worktrees; do
    echo "\nDeleting worktree : $worktree"
    result=$(git w remove $worktree 2>&1)
    if [[ -n $result ]]; then
        echo "  $result"
        continue
    fi
    echo "  Successfully deleted $worktree"
done
