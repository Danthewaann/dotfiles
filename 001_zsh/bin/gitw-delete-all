#!/bin/bash

set -e

# Delete all git worktrees in current bare repository
barerepo=$(git rev-parse --is-bare-repository)
if [[ $barerepo != "true" ]]; then
    echo "Must be run in bare repository"
    exit 1
fi

worktrees=()
while IFS='' read -r line; do worktrees+=("$line"); done < <(git worktree list | grep -vE "(\[main\]|\[master\]|\(bare\))" | cut -d' ' -f1)
if [[ ${#worktrees[@]} -eq 0 ]]; then
    echo "No worktrees to delete"
    exit 1
fi

for worktree in "${worktrees[@]}"; do
    printf "\nDeleting worktree : %s\n" "$worktree"
    if ! result=$(git worktree remove "$worktree" "$@" 2>&1); then
        echo "  $result"
        continue
    fi
    echo "  Successfully deleted $worktree"
done
