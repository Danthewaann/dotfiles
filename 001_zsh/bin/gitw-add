#!/usr/bin/env bash

set -eo pipefail

CUR_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

source "$CUR_DIR/_git-common"

args=()
branch_name=
checkout_only=0
copy_venv=0

function usage() {
    cat <<-END
branch_name      name of the branch to create
--checkout-only  only checkout the branch
--copy           copy .venv from base worktree into new worktree
END
}

while [[ $# -gt 0 ]]; do
    case $1 in
    -h|--help)
        usage
        exit 2
        ;;
    --checkout-only)
        checkout_only=1
        shift
        ;;
    --copy)
        copy_venv=1
        shift
        ;;
    *)
        args+=("$1")
        shift
        ;;
    esac
done

if ! is_bare_repo=$(git rev-parse --is-bare-repository 2>&1); then true; fi
if [[ $is_bare_repo != "true" ]]; then
    error "Must be run in a bare repository!"
    exit 1
fi

set -- "${args[@]}"

>&2 echo

if [[ $# -lt 1 ]]; then
    error "Must provide a branch name"
    exit 1
fi

branch_name="$1"; shift

# Remove the first path segment if branch name contains forward slashes
trimmed_name=$(echo "$branch_name" | cut -d'/' -f2-)

# Convert all forward slashes to dashes
converted_name=${trimmed_name//\//-}

if [[ -d $converted_name ]]; then
    error "Worktee '$converted_name' already exists"
    exit 1
fi

info "Running git fetch..."
if ! output=$(git fetch 2>&1); then
    error "$output"
    exit 1
else
    if [[ -n "$output" ]]; then
        echo "$output"
    fi
fi
>&2 echo

# Create a new worktree using the converted name
info "Creating worktree..."
if ! output=$(git worktree add "$converted_name" "$@" 2>&1); then
    error "$output"
    exit 1
else
    if [[ -n "$output" ]]; then
        echo "$output"
    fi
fi
>&2 echo

# Enter the new worktree
cd "$converted_name" || exit

info "Creating branch..."

# Attempt to rename worktree branch to use the correct branch name
if ! output=$(git branch -m "$branch_name" 2>&1); then
    # If the branch name already exists, check it out instead of creating it
    if [[ $output == *"already exists"* ]]; then
        echo "Branch '$branch_name' exists locally, switching to it"
        if ! output=$(git checkout "$branch_name" 2>&1); then
            error "Failed to checkout branch : $output"
            exit 1
        fi
        if ! output=$(git rev-parse --abbrev-ref "$branch_name@{upstream}" 2>&1); then
            echo "Branch '$branch_name' has no upstream set, setting to 'origin/$branch_name'"
            if ! output=$(git branch --set-upstream-to=origin/"$branch_name" 2>&1); then
                warn "Failed to set upstream for branch : $output"
            fi
        fi
    fi
# Check if the branch exists remotely, if it does set it as upstream and hard reset to it
elif git branch -r | grep "$branch_name" > /dev/null 2>&1; then
    echo "Branch '$branch_name' exists remotely, setting as upsteam and hard resetting to it"
    if ! output=$(git branch --set-upstream-to=origin/"$branch_name" 2>&1); then
        error "Failed to set upstream to branch : $output"
        exit 1
    fi
    if ! output=$(git reset --hard origin/"$branch_name" 2>&1); then
        error "Failed to hard reset branch : $output"
        exit 1
    fi

    >&2 echo
    info "Running git pull..."
    >&2 git pull 
fi


# Optional post checkout steps
if [[ $checkout_only -ne 1 ]]; then
    current_dir=$(pwd)
    base_worktree=$(gitw-get-base 2> /dev/null)

    if [[ $copy_venv -eq 1 ]] && [[ -d "../$base_worktree/.venv" ]]; then
        >&2 echo
        info "Copying ../$base_worktree/.venv to $converted_name/.venv"
        mkdir -p "$current_dir/$converted_name/.venv"
        # From https://www.zylk.net/en/web-2-0/blog/-/blogs/how-to-copy-files-in-linux-faster-and-safer-than-cp
        cd "$current_dir/$base_worktree/.venv"; tar cf - . | (cd "$current_dir/$converted_name/.venv"; tar xvf -) 2> /dev/null
    elif [[ -f "poetry.lock" ]]; then
        >&2 echo
        info "Running poetry install..."
        >&2 echo
        script -q /dev/null poetry install
    fi

    if [[ -f "pyproject.toml" ]] && [[ -f "$HOME/pyrightconfig.json" ]] && ! [[ -f "pyrightconfig.json" ]]; then
        >&2 echo
        info "Linking pyrightconfig.json file..."
        ln -s "$HOME/pyrightconfig.json" "pyrightconfig.json"
    fi
fi

>&2 echo
success "Successfully created worktree!"
>&2 echo
echo "${converted_name}"
