#!/bin/bash

set -e

function get_base() {
    base_worktree=

    if [[ -d main ]]; then
        base_worktree="main"
    elif [[ -d master ]]; then
        base_worktree="master"
    else
        >&2 echo "ERROR: main or master worktree not found"
        return 1
    fi

    >&2 echo -n "Base worktree is: "
    echo "$base_worktree"
}

>&2 echo

is_bare_repo=$(git rev-parse --is-bare-repository)
if [[ $is_bare_repo == "true" ]]; then
    get_base
    exit
fi

in_worktree=$(git rev-parse --is-inside-work-tree)
if [[ $in_worktree == "true" ]]; then
    while true; do
        cd ..
        is_bare_repo=$(git rev-parse --is-bare-repository)
        if [[ $is_bare_repo == "true" ]]; then
            get_base
            break
        fi
    done
else
    echo "ERROR: Must be run inside a git worktree or bare repository"
    exit 1
fi

