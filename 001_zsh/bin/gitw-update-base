#!/bin/bash

set -e

function update_base() {
    >&2 echo

    base_worktree=
    if [[ -d main ]]; then
        base_worktree="main"
    elif [[ -d master ]]; then
        base_worktree="master"
    else
        >&2 echo "ERROR: main or master worktree not found"
        return 1
    fi

    >&2 echo "Entering '$base_worktree' base worktree"
    cd "$base_worktree" || exit

    >&2 echo "Updating with remote"
    # shellcheck disable=SC2210
    >&2 git pull 

    echo "$base_worktree"
}

is_bare_repo=$(git rev-parse --is-bare-repository)
if [[ $is_bare_repo == "true" ]]; then
    update_base
    exit
fi

in_worktree=$(git rev-parse --is-inside-work-tree)
if [[ $in_worktree == "true" ]]; then
    while true; do
        cd ..
        is_bare_repo=$(git rev-parse --is-bare-repository)
        if [[ $is_bare_repo == "true" ]]; then
            update_base
            break
        fi
    done
else
    echo "Must be run inside a git worktree"
    exit 1
fi

